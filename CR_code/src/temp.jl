include("util.jl")
include("train.jl")
using PyPlot
function temp()
    # ml100k
    # TRAIN_PATH="/Users/Weilong/Codes/CR_data/ml-100k/train_given50.lsvm"
    # VALIDATE_PATH="/Users/Weilong/Codes/CR_data/ml-100k/validate_given50.lsvm"
    # TEST_PATH="/Users/Weilong/Codes/CR_data/ml-100k/test_given50.lsvm"
    # U_PATH="/Users/Weilong/Codes/CR_data/ml-100k/U_given50.lsvm"
    # V_PATH="/Users/Weilong/Codes/CR_data/ml-100k/V_given50.lsvm"

    # ml1m
    TRAIN_PATH="/Users/Weilong/Codes/CR_data/ml-1m/train_given10.lsvm"
    VALIDATE_PATH="/Users/Weilong/Codes/CR_data/ml-1m/validate_given10.lsvm"
    TEST_PATH="/Users/Weilong/Codes/CR_data/ml-1m/test_given10.lsvm"
    U_PATH="/Users/Weilong/Codes/CR_data/ml-1m/U_given10.lsvm"
    V_PATH="/Users/Weilong/Codes/CR_data/ml-1m/V_given10.lsvm"


    relThreshold = 4
    useCofi = false
    dimW = 10
    X = readdlm(TRAIN_PATH)
    T = readdlm(TEST_PATH)
    Y = readdlm(VALIDATE_PATH)
    m = countlines(U_PATH)
    n = countlines(V_PATH)

    if useCofi == false
        srand(1234) # testset seed
        U = randn((dimW, m))
        V = randn((dimW, n))
    else
        U = []
        V = [] # TODO optimize
        U = read_numeric_matrix_from_file(U_PATH, m,dimW)
        V = read_numeric_matrix_from_file(V_PATH, n,dimW)
        U = transpose(U)
        V = transpose(V)
        println(size(U)[2])
        println(size(V)[2])
        @assert any(U .< 100) "U contains entry >= 1e5"
        @assert any(V .< 100) "V contains entry >= 1e5"
    end
    X, U,Y,T= preprocessing(X, U, Y, T, relThreshold)

    scoreT = evaluate(U, V, T, k=10, relThreshold=4, metric=1)
    scoreY = evaluate(U, V, Y, k=10, relThreshold=4, metric=1)
    scoreX = evaluate(U, V, X, k=10, relThreshold=4, metric=1)

    println(scoreT)
    println(scoreY)
    println(scoreX)
end

function tempPlot()
    plotDir = "/Users/Weilong/Desktop/out_figure/exp_500iter/"
    curTime = Dates.value(now())
    dataset = 2
    useCofi = true
    algo = 2
    metric =1
    ni =10
    k = 10
    plotLoss = true
    # pnorm 
    plotY_eval = [0.817603, 0.820971, 0.82295, 0.823261, 0.824085, 0.822751, 0.823897, 0.823186, 0.822689, 0.823113, 0.822606, 0.822694, 0.823055, 0.822885, 0.822223, 0.821719, 0.821791, 0.821558, 0.821665, 0.821507, 0.821264, 0.822053, 0.821736, 0.821939, 0.821997, 0.821854, 0.82154, 0.821019, 0.821508, 0.821378, 0.821594, 0.821781, 0.821352, 0.821278, 0.821323, 0.821123, 0.82118, 0.820955, 0.820597, 0.820396, 0.820406, 0.820238, 0.820359, 0.820468, 0.820569, 0.820327, 0.82013, 0.820188, 0.820435, 0.820742, 0.820944, 0.820893, 0.820553, 0.820606, 0.82061, 0.820691, 0.820678, 0.820715, 0.820753, 0.820606, 0.820351, 0.82043, 0.820422, 0.820306, 0.820247, 0.820059, 0.820291, 0.820177, 0.820042, 0.820073, 0.820216, 0.82027, 0.82034, 0.820558, 0.820632, 0.820575, 0.82058, 0.82038, 0.820595, 0.820678, 0.820694, 0.8207, 0.820638, 0.820634, 0.820663, 0.82067, 0.820679, 0.820518, 0.820651, 0.820606, 0.820712, 0.820857, 0.820828, 0.820908, 0.82107, 0.821183, 0.821201, 0.821185, 0.821328, 0.821444, 0.821271, 0.820956, 0.820971, 0.821094, 0.821079, 0.820514, 0.820562, 0.820611, 0.820589, 0.820558, 0.820636, 0.820574, 0.82066, 0.820708, 0.820774, 0.820805, 0.820708, 0.82062, 0.820847, 0.820897, 0.820957, 0.820957, 0.821096, 0.82091, 0.820929, 0.820906, 0.820941, 0.820837, 0.820657, 0.820593, 0.820694, 0.82074, 0.820839, 0.820986, 0.821054, 0.820937, 0.820912, 0.820787, 0.820728, 0.820805, 0.820836, 0.820891, 0.821014, 0.820875, 0.820859, 0.820722, 0.820783, 0.820972, 0.820958, 0.820933, 0.821056, 0.821159, 0.821013, 0.821126, 0.821577, 0.821574, 0.821471, 0.821458, 0.821446, 0.821484, 0.821495, 0.821687, 0.821765, 0.82179, 0.821766, 0.821701, 0.821679, 0.821674, 0.821748, 0.821727, 0.821701, 0.821842, 0.821738, 0.821603, 0.821586, 0.821592, 0.821626, 0.82164, 0.821734, 0.821799, 0.821802, 0.82182, 0.821758, 0.821522, 0.821563, 0.821646, 0.821769, 0.8218, 0.82185, 0.822024, 0.82192, 0.821857, 0.822014, 0.822104, 0.821995, 0.821928, 0.822008, 0.821947, 0.82197, 0.821931, 0.821972, 0.822028, 0.822003, 0.822001, 0.822107, 0.822109, 0.821957, 0.821942, 0.821905, 0.82174, 0.82181, 0.821865, 0.821555, 0.821664, 0.821749, 0.82176, 0.821767, 0.821766, 0.821764, 0.821747, 0.821729, 0.821668, 0.821587, 0.821603, 0.821527, 0.821531, 0.8215, 0.821522, 0.821582, 0.821516, 0.821584, 0.821609, 0.821651, 0.821648, 0.821705, 0.821718, 0.821724, 0.821679, 0.821596, 0.821527, 0.821406, 0.821259, 0.821242, 0.821138, 0.821189, 0.821262, 0.821284, 0.821566, 0.8216, 0.821666, 0.821662, 0.821628, 0.821659, 0.821661, 0.821475, 0.82151, 0.821544, 0.821524, 0.821569, 0.821618, 0.821717, 0.82171, 0.82162, 0.821725, 0.82168, 0.821677, 0.821675, 0.821674, 0.821688, 0.821624, 0.821577, 0.821634, 0.821632, 0.821597, 0.821611, 0.821556, 0.821585, 0.821543, 0.821548, 0.821511, 0.821486, 0.821404, 0.821411, 0.821364, 0.821273, 0.821325, 0.821237, 0.821221, 0.821199, 0.821164, 0.821199, 0.821185, 0.821167, 0.821024, 0.821011, 0.821098, 0.821099, 0.821091, 0.82107, 0.821023, 0.821051, 0.821019, 0.821131, 0.821252, 0.821206, 0.821052, 0.821082, 0.821095, 0.821032, 0.820826, 0.820796, 0.820782, 0.820762, 0.820762, 0.820744, 0.820803, 0.820801, 0.820795, 0.820801, 0.820756, 0.820701, 0.82071, 0.820364, 0.820369, 0.820356, 0.820346, 0.820349, 0.820266, 0.820179, 0.820271, 0.820271, 0.820276, 0.820291, 0.820306, 0.820306, 0.820366, 0.820237, 0.82027, 0.820341, 0.820427, 0.820481, 0.820491, 0.820459, 0.820435, 0.820384, 0.820471, 0.82041, 0.82036, 0.820318, 0.820399, 0.820462, 0.820564, 0.820422, 0.820476, 0.8205, 0.820526, 0.820554, 0.82068, 0.82064, 0.820488, 0.820448, 0.820379, 0.820383, 0.820346, 0.82035, 0.820341, 0.820295, 0.820351, 0.820292, 0.820292, 0.82029, 0.820329, 0.820329, 0.820252, 0.8202, 0.820248, 0.820228, 0.820228, 0.820169, 0.820185, 0.820042, 0.820008, 0.82008, 0.820064, 0.820147, 0.820138, 0.820003, 0.819959, 0.819959, 0.819937, 0.81981, 0.819711, 0.819627, 0.819548, 0.819523, 0.819503, 0.819596, 0.819656, 0.819656, 0.819638, 0.819606, 0.819624, 0.819659, 0.819585, 0.819493, 0.819474, 0.819463, 0.819475, 0.819503, 0.819464, 0.81947, 0.819431, 0.81933, 0.819371, 0.819371, 0.819387, 0.819429, 0.819413, 0.819364, 0.81941, 0.819434, 0.819436, 0.819506, 0.819522, 0.819419, 0.819507, 0.819507, 0.819524, 0.819701, 0.819665, 0.819668, 0.819588, 0.819568, 0.819585, 0.819569, 0.819515, 0.819515, 0.819486, 0.81953, 0.819548, 0.819558, 0.819505, 0.819626, 0.819596, 0.819629, 0.819646, 0.819749, 0.819759, 0.819696, 0.819638, 0.819636, 0.819528, 0.819443, 0.819364, 0.819316, 0.819292, 0.819276, 0.819276, 0.819167, 0.819167, 0.819133, 0.819099, 0.819092, 0.819075, 0.819058, 0.819058, 0.81912, 0.819053, 0.819062, 0.81895, 0.818972, 0.818855, 0.818855, 0.818818, 0.818889, 0.818851, 0.818803, 0.8188, 0.81882, 0.81882, 0.818861, 0.818841, 0.818862, 0.81885, 0.818867, 0.818886, 0.81887, 0.818876, 0.81884, 0.81885, 0.818935, 0.818988, 0.819011, 0.819007, 0.818994, 0.818939, 0.818923, 0.81894, 0.818944, 0.818894]
    plotY_train = [0.971243, 0.971727, 0.97166, 0.971259, 0.971069, 0.970791, 0.970882, 0.971553, 0.971904, 0.971837, 0.971363, 0.971393, 0.97141, 0.970986, 0.970691, 0.970356, 0.969017, 0.969008, 0.96858, 0.968238, 0.96807, 0.967929, 0.967673, 0.967544, 0.967387, 0.967072, 0.966579, 0.966316, 0.966315, 0.966222, 0.966236, 0.965699, 0.965575, 0.965463, 0.965421, 0.965348, 0.965174, 0.965024, 0.964798, 0.964478, 0.964487, 0.964395, 0.964286, 0.96426, 0.964153, 0.96426, 0.964049, 0.963843, 0.963909, 0.963583, 0.963632, 0.963696, 0.963418, 0.96331, 0.963151, 0.963239, 0.963167, 0.963027, 0.963253, 0.963614, 0.963708, 0.963671, 0.963839, 0.963837, 0.96372, 0.963752, 0.96377, 0.96377, 0.96401, 0.96398, 0.963819, 0.963944, 0.963834, 0.963963, 0.963963, 0.963927, 0.964067, 0.964053, 0.96406, 0.96406, 0.964344, 0.964391, 0.964118, 0.964062, 0.964124, 0.964239, 0.963973, 0.963934, 0.964008, 0.964126, 0.96415, 0.964198, 0.964203, 0.964879, 0.964861, 0.965011, 0.964852, 0.964946, 0.964926, 0.964936, 0.965045, 0.965093, 0.965127, 0.965202, 0.965293, 0.965462, 0.965532, 0.965677, 0.965677, 0.965771, 0.965876, 0.965979, 0.966021, 0.966055, 0.966015, 0.966135, 0.966165, 0.966041, 0.966041, 0.966131, 0.966034, 0.966064, 0.965576, 0.965657, 0.965717, 0.965765, 0.966024, 0.966377, 0.966523, 0.966662, 0.966729, 0.966834, 0.966993, 0.966985, 0.967007, 0.967079, 0.967079, 0.967116, 0.967152, 0.967394, 0.967466, 0.96748, 0.967536, 0.967416, 0.967487, 0.967468, 0.96755, 0.96757, 0.967604, 0.968455, 0.968607, 0.968652, 0.969051, 0.969185, 0.969219, 0.969327, 0.969409, 0.96945, 0.969475, 0.969715, 0.969836, 0.969836, 0.969959, 0.970007, 0.970074, 0.970108, 0.970236, 0.970561, 0.971134, 0.971248, 0.971282, 0.971582, 0.971684, 0.97182, 0.972, 0.972167, 0.972262, 0.972362, 0.97242, 0.972629, 0.972745, 0.972933, 0.973023, 0.973023, 0.973065, 0.973196, 0.973282, 0.973347, 0.973437, 0.973566, 0.973566, 0.973629, 0.973658, 0.973745, 0.973745, 0.973816, 0.974204, 0.974204, 0.974681, 0.974697, 0.974786, 0.974852, 0.974924, 0.975035, 0.975053, 0.975079, 0.975222, 0.975327, 0.975565, 0.975685, 0.975717, 0.975717, 0.975777, 0.975962, 0.976142, 0.97619, 0.976292, 0.976467, 0.976595, 0.976635, 0.976587, 0.976549, 0.976656, 0.976743, 0.976873, 0.977066, 0.977178, 0.97749, 0.977529, 0.977544, 0.977573, 0.977683, 0.977723, 0.977895, 0.977983, 0.977957, 0.978043, 0.978085, 0.978134, 0.978263, 0.978293, 0.978415, 0.978479, 0.978479, 0.978705, 0.978792, 0.978864, 0.978996, 0.97903, 0.979078, 0.979184, 0.979184, 0.979241, 0.979207, 0.97929, 0.979356, 0.979513, 0.979513, 0.979513, 0.979513, 0.979513, 0.979702, 0.979702, 0.979736, 0.979736, 0.979714, 0.979718, 0.979983, 0.980056, 0.980056, 0.980341, 0.980438, 0.980498, 0.980618, 0.980857, 0.980892, 0.98126, 0.981277, 0.981375, 0.9814, 0.98152, 0.981626, 0.981764, 0.98178, 0.981814, 0.981934, 0.981959, 0.981959, 0.982028, 0.9821, 0.982125, 0.98225, 0.98237, 0.982322, 0.98238, 0.98238, 0.982396, 0.98243, 0.982499, 0.982605, 0.982687, 0.982703, 0.982775, 0.982929, 0.983152, 0.983152, 0.983202, 0.983202, 0.983308, 0.983439, 0.983662, 0.983752, 0.983772, 0.983891, 0.983911, 0.983983, 0.984077, 0.984267, 0.984267, 0.984398, 0.984424, 0.984424, 0.984424, 0.984424, 0.984472, 0.98464, 0.984662, 0.984704, 0.984744, 0.984778, 0.984778, 0.984995, 0.985055, 0.985055, 0.985112, 0.985112, 0.98517, 0.98523, 0.98523, 0.985252, 0.985252, 0.985232, 0.985232, 0.985232, 0.98525, 0.98534, 0.986093, 0.986093, 0.986113, 0.986113, 0.986113, 0.986113, 0.986113, 0.986831, 0.986831, 0.986879, 0.986954, 0.986979, 0.986999, 0.986999, 0.987089, 0.987183, 0.987203, 0.987371, 0.987444, 0.987484, 0.987592, 0.987618, 0.987618, 0.987665, 0.9877, 0.987775, 0.987801, 0.98804, 0.988056, 0.988082, 0.98813, 0.98813, 0.98813, 0.988178, 0.988284, 0.988304, 0.988351, 0.988423, 0.988495, 0.988495, 0.988543, 0.988543, 0.988543, 0.988663, 0.988663, 0.988663, 0.98868, 0.988764, 0.988794, 0.988794, 0.988794, 0.988841, 0.988889, 0.988889, 0.988909, 0.988909, 0.988935, 0.989007, 0.989152, 0.989152, 0.9892, 0.9892, 0.989234, 0.989234, 0.989394, 0.989428, 0.989428, 0.989428, 0.989448, 0.989448, 0.989448, 0.989448, 0.989468, 0.989468, 0.989708, 0.989708, 0.989708, 0.989708, 0.989728, 0.989762, 0.989791, 0.989791, 0.989791, 0.989791, 0.989863, 0.989863, 0.989863, 0.98994, 0.989978, 0.990007, 0.990007, 0.990007, 0.990007, 0.990033, 0.990164, 0.990164, 0.990164, 0.990164, 0.990235, 0.990253, 0.990253, 0.990275, 0.990395, 0.990415, 0.990534, 0.99056, 0.99056, 0.99058, 0.99058, 0.99058, 0.99058, 0.990628, 0.990748, 0.99077, 0.99077, 0.990862, 0.990862, 0.990862, 0.99091, 0.990928, 0.990979, 0.990979, 0.990995, 0.990995, 0.990995, 0.991029, 0.991051, 0.991099, 0.991099, 0.991099, 0.991099, 0.991099, 0.991099, 0.991099, 0.991463, 0.991531, 0.991583, 0.991583, 0.991583, 0.991583, 0.991583, 0.991583, 0.9916, 0.9916, 0.991635, 0.991682, 0.991708, 0.991708, 0.991744, 0.991744, 0.99176, 0.99176, 0.991786, 0.991811]
    plotY_obj = [679.335, 653.614, 631.623, 612.554, 595.831, 581.032, 567.832, 555.982, 545.28, 535.564, 526.702, 518.581, 511.109, 504.208, 497.808, 491.852, 486.29, 481.077, 476.176, 471.552, 467.177, 463.024, 459.071, 455.297, 451.684, 448.216, 444.879, 441.661, 438.549, 435.535, 432.608, 429.762, 426.988, 424.281, 421.636, 419.046, 416.507, 414.016, 411.569, 409.162, 406.793, 404.46, 402.159, 399.889, 397.648, 395.435, 393.247, 391.085, 388.945, 386.829, 384.734, 382.66, 380.605, 378.57, 376.554, 374.556, 372.575, 370.611, 368.664, 366.733, 364.818, 362.918, 361.033, 359.163, 357.308, 355.466, 353.639, 351.825, 350.024, 348.236, 346.461, 344.698, 342.947, 341.209, 339.482, 337.767, 336.063, 334.37, 332.688, 331.016, 329.355, 327.705, 326.064, 324.433, 322.812, 321.201, 319.599, 318.006, 316.422, 314.847, 313.281, 311.724, 310.175, 308.634, 307.102, 305.578, 304.062, 302.554, 301.053, 299.561, 298.076, 296.599, 295.129, 293.667, 292.212, 290.765, 289.325, 287.892, 286.466, 285.047, 283.635, 282.23, 280.832, 279.441, 278.057, 276.68, 275.31, 273.946, 272.589, 271.239, 269.895, 268.558, 267.228, 265.904, 264.587, 263.277, 261.973, 260.675, 259.384, 258.1, 256.822, 255.55, 254.285, 253.026, 251.774, 250.528, 249.288, 248.055, 246.828, 245.607, 244.393, 243.185, 241.983, 240.788, 239.599, 238.416, 237.239, 236.069, 234.904, 233.746, 232.594, 231.448, 230.309, 229.175, 228.048, 226.926, 225.811, 224.702, 223.599, 222.502, 221.411, 220.326, 219.246, 218.173, 217.106, 216.045, 214.99, 213.941, 212.897, 211.86, 210.828, 209.802, 208.782, 207.768, 206.759, 205.757, 204.76, 203.768, 202.783, 201.803, 200.829, 199.86, 198.898, 197.94, 196.989, 196.042, 195.102, 194.167, 193.237, 192.313, 191.394, 190.481, 189.573, 188.671, 187.774, 186.882, 185.995, 185.114, 184.238, 183.367, 182.502, 181.641, 180.786, 179.936, 179.091, 178.251, 177.417, 176.587, 175.762, 174.942, 174.127, 173.318, 172.513, 171.712, 170.917, 170.127, 169.341, 168.56, 167.784, 167.012, 166.246, 165.483, 164.726, 163.973, 163.225, 162.481, 161.742, 161.007, 160.277, 159.551, 158.83, 158.113, 157.4, 156.692, 155.988, 155.288, 154.593, 153.902, 153.215, 152.532, 151.853, 151.179, 150.508, 149.842, 149.18, 148.522, 147.867, 147.217, 146.571, 145.928, 145.29, 144.655, 144.025, 143.398, 142.774, 142.155, 141.539, 140.927, 140.319, 139.715, 139.114, 138.516, 137.923, 137.333, 136.746, 136.163, 135.584, 135.007, 134.435, 133.866, 133.3, 132.738, 132.179, 131.623, 131.071, 130.521, 129.976, 129.433, 128.894, 128.358, 127.825, 127.295, 126.768, 126.245, 125.724, 125.207, 124.693, 124.182, 123.673, 123.168, 122.666, 122.166, 121.67, 121.176, 120.686, 120.198, 119.713, 119.231, 118.752, 118.275, 117.802, 117.331, 116.862, 116.397, 115.934, 115.474, 115.016, 114.561, 114.109, 113.66, 113.212, 112.768, 112.326, 111.887, 111.45, 111.015, 110.583, 110.154, 109.727, 109.302, 108.88, 108.46, 108.043, 107.627, 107.215, 106.804, 106.396, 105.99, 105.587, 105.185, 104.786, 104.39, 103.995, 103.603, 103.212, 102.824, 102.438, 102.055, 101.673, 101.294, 100.916, 100.541, 100.167, 99.7963, 99.4271, 99.0599, 98.6948, 98.3316, 97.9705, 97.6113, 97.254, 96.8988, 96.5454, 96.1939, 95.8444, 95.4968, 95.151, 94.8071, 94.465, 94.1248, 93.7864, 93.4499, 93.1151, 92.7821, 92.4509, 92.1215, 91.7938, 91.4679, 91.1437, 90.8212, 90.5005, 90.1814, 89.864, 89.5483, 89.2343, 88.9219, 88.6111, 88.302, 87.9945, 87.6886, 87.3843, 87.0816, 86.7805, 86.4809, 86.1829, 85.8865, 85.5915, 85.2982, 85.0063, 84.7159, 84.427, 84.1396, 83.8537, 83.5693, 83.2863, 83.0047, 82.7246, 82.446, 82.1687, 81.8929, 81.6184, 81.3454, 81.0737, 80.8034, 80.5345, 80.2669, 80.0007, 79.7358, 79.4722, 79.21, 78.9491, 78.6895, 78.4312, 78.1742, 77.9184, 77.6639, 77.4107, 77.1588, 76.9081, 76.6586, 76.4104, 76.1634, 75.9176, 75.673, 75.4296, 75.1874, 74.9464, 74.7066, 74.468, 74.2305, 73.9942, 73.759, 73.5249, 73.292, 73.0603, 72.8296, 72.6001, 72.3717, 72.1443, 71.9181, 71.693, 71.4689, 71.2459, 71.024, 70.8031, 70.5833, 70.3645, 70.1468, 69.9301, 69.7145, 69.4998, 69.2862, 69.0736, 68.862, 68.6514, 68.4417, 68.2331, 68.0254, 67.8188, 67.613, 67.4083, 67.2045, 67.0016, 66.7997, 66.5988, 66.3987, 66.1996, 66.0015, 65.8042, 65.6078, 65.4124, 65.2178, 65.0242, 64.8314, 64.6395, 64.4485, 64.2584, 64.0691, 63.8807, 63.6932, 63.5065, 63.3207, 63.1357, 62.9515, 62.7682, 62.5857, 62.404, 62.2232, 62.0431, 61.8639, 61.6855, 61.5078, 61.331, 61.155, 60.9797, 60.8052, 60.6315, 60.4586, 60.2865, 60.1151]
    plotFigure(plotLoss, plotDir, curTime, dataset,useCofi, algo, metric, ni, k, plotY_eval, plotY_train, plotY_obj)
end

# temp()
tempPlot()


























